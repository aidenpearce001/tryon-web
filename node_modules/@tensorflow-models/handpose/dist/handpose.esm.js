/**
    * @license
    * Copyright 2020 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
import{loadGraphModel as t}from"@tensorflow/tfjs-converter";import{image as n,tensor2d as e,tensor1d as r,tidy as o,slice as i,add as s,div as a,mul as u,sub as h,concat2d as d,getBackend as c,env as f,sigmoid as l,reshape as p,util as m,Tensor as v,browser as P}from"@tensorflow/tfjs-core";function g(t,n,e,r){return new(e||(e=Promise))((function(o,i){function s(t){try{u(r.next(t))}catch(t){i(t)}}function a(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(s,a)}u((r=r.apply(t,n||[])).next())}))}function b(t,n){var e,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;s;)try{if(e=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(t,s)}catch(t){i=[6,t],r=0}finally{e=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function k(t){return[Math.abs(t.endPoint[0]-t.startPoint[0]),Math.abs(t.endPoint[1]-t.startPoint[1])]}function x(t){return[t.startPoint[0]+(t.endPoint[0]-t.startPoint[0])/2,t.startPoint[1]+(t.endPoint[1]-t.startPoint[1])/2]}function y(t,n){void 0===n&&(n=1.5);var e=x(t),r=k(t),o=[n*r[0]/2,n*r[1]/2];return{startPoint:[e[0]-o[0],e[1]-o[1]],endPoint:[e[0]+o[0],e[1]+o[1]],palmLandmarks:t.palmLandmarks}}function w(t){var n=x(t),e=k(t),r=Math.max.apply(Math,e)/2;return{startPoint:[n[0]-r,n[1]-r],endPoint:[n[0]+r,n[1]+r],palmLandmarks:t.palmLandmarks}}function L(t,n){var e=[t.endPoint[0]-t.startPoint[0],t.endPoint[1]-t.startPoint[1]],r=[e[0]*n[0],e[1]*n[1]];return{startPoint:[t.startPoint[0]+r[0],t.startPoint[1]+r[1]],endPoint:[t.endPoint[0]+r[0],t.endPoint[1]+r[1]],palmLandmarks:t.palmLandmarks}}var B=function(){function t(t,n,o,i,s,a){this.model=t,this.width=n,this.height=o,this.iouThreshold=s,this.scoreThreshold=a,this.anchors=i.map((function(t){return[t.x_center,t.y_center]})),this.anchorsTensor=e(this.anchors),this.inputSizeTensor=r([n,o]),this.doubleInputSizeTensor=r([2*n,2*o])}return t.prototype.normalizeBoxes=function(t){var n=this;return o((function(){var e=i(t,[0,0],[-1,2]),r=i(t,[0,2],[-1,2]),o=s(a(e,n.inputSizeTensor),n.anchorsTensor),c=a(r,n.doubleInputSizeTensor),f=u(h(o,c),n.inputSizeTensor),l=u(s(o,c),n.inputSizeTensor);return d([f,l],1)}))},t.prototype.normalizeLandmarks=function(t,n){var e=this;return o((function(){var r=s(a(t.reshape([-1,7,2]),e.inputSizeTensor),e.anchors[n]);return u(r,e.inputSizeTensor)}))},t.prototype.getBoundingBoxes=function(t){return g(this,void 0,void 0,(function(){var e,r,s,a,d,p,m,v,P,g,k,x,y,w,L,B=this;return b(this,(function(b){switch(b.label){case 0:return e=o((function(){return u(h(t,.5),2)})),"webgl"===c()?(s=f().get("WEBGL_PACK_DEPTHWISECONV"),f().set("WEBGL_PACK_DEPTHWISECONV",!0),r=this.model.predict(e),f().set("WEBGL_PACK_DEPTHWISECONV",s)):r=this.model.predict(e),a=r.squeeze(),d=o((function(){return l(i(a,[0,0],[-1,1])).squeeze()})),p=i(a,[0,1],[-1,4]),m=this.normalizeBoxes(p),v=console.warn,console.warn=function(){},P=n.nonMaxSuppression(m,d,1,this.iouThreshold,this.scoreThreshold),console.warn=v,[4,P.array()];case 1:return g=b.sent(),k=[e,r,P,a,m,p,d],0===g.length?(k.forEach((function(t){return t.dispose()})),[2,null]):(x=g[0],y=i(m,[x,0],[1,-1]),w=i(a,[x,5],[1,14]),L=o((function(){return B.normalizeLandmarks(w,x).reshape([-1,2])})),k.push(w),k.forEach((function(t){return t.dispose()})),[2,{boxes:y,palmLandmarks:L}])}}))}))},t.prototype.estimateHandBounds=function(t){return g(this,void 0,void 0,(function(){var n,e,r,i,s,a,u,h,d=this;return b(this,(function(c){switch(c.label){case 0:return n=t.shape[1],e=t.shape[2],r=o((function(){return t.resizeBilinear([d.width,d.height]).div(255)})),[4,this.getBoundingBoxes(r)];case 1:return null===(i=c.sent())?(r.dispose(),[2,null]):(s=i.boxes.arraySync(),a=s[0].slice(0,2),u=s[0].slice(2,4),h=i.palmLandmarks.arraySync(),r.dispose(),i.boxes.dispose(),i.palmLandmarks.dispose(),[2,(f={startPoint:a,endPoint:u,palmLandmarks:h},l=[e/this.width,n/this.height],{startPoint:[f.startPoint[0]*l[0],f.startPoint[1]*l[1]],endPoint:[f.endPoint[0]*l[0],f.endPoint[1]*l[1]],palmLandmarks:f.palmLandmarks.map((function(t){return[t[0]*l[0],t[1]*l[1]]}))})])}var f,l}))}))},t}(),I={thumb:[1,2,3,4],indexFinger:[5,6,7,8],middleFinger:[9,10,11,12],ringFinger:[13,14,15,16],pinky:[17,18,19,20],palmBase:[0]};function C(t,n){var e,r=Math.PI/2-Math.atan2(-(n[1]-t[1]),n[0]-t[0]);return(e=r)-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}var H=function(t,n){return[[1,0,t],[0,1,n],[0,0,1]]};function M(t,n){for(var e=0,r=0;r<t.length;r++)e+=t[r]*n[r];return e}function T(t,n){for(var e=[],r=0;r<t.length;r++)e.push(t[r][n]);return e}function E(t,n){for(var e=[],r=t.length,o=0;o<r;o++){e.push([]);for(var i=0;i<r;i++)e[o].push(M(t[o],T(n,i)))}return e}function O(t,n){var e=Math.cos(t),r=Math.sin(t),o=[[e,-r,0],[r,e,0],[0,0,1]],i=E(H(n[0],n[1]),o);return E(i,H(-n[0],-n[1]))}function S(t,n){return[M(t,n[0]),M(t,n[1])]}var W=[0,-.4],z=[0,-.1],D=[0,5,9,13,17,1,2],_=function(){function t(t,n,e,r,o,i){this.regionsOfInterest=[],this.runsWithoutHandDetector=0,this.boundingBoxDetector=t,this.meshDetector=n,this.maxContinuousChecks=o,this.detectionConfidence=i,this.meshWidth=e,this.meshHeight=r,this.maxHandsNumber=1}return t.prototype.getBoxForPalmLandmarks=function(t,n){var e=t.map((function(t){return S(t.concat([1]),n)}));return y(w(L(this.calculateLandmarksBoundingBox(e),W)),3)},t.prototype.getBoxForHandLandmarks=function(t){for(var n=y(w(L(this.calculateLandmarksBoundingBox(t),z)),1.65),e=[],r=0;r<D.length;r++)e.push(t[D[r]].slice(0,2));return n.palmLandmarks=e,n},t.prototype.transformRawCoords=function(t,n,e,r){var o,i,s,a,u=this,h=k(n),d=[h[0]/this.meshWidth,h[1]/this.meshHeight],c=t.map((function(t){return[d[0]*(t[0]-u.meshWidth/2),d[1]*(t[1]-u.meshHeight/2),t[2]]})),f=O(e,[0,0]),l=c.map((function(t){return S(t,f).concat([t[2]])})),p=(i=[[(o=r)[0][0],o[1][0]],[o[0][1],o[1][1]]],s=[o[0][2],o[1][2]],a=[-M(i[0],s),-M(i[1],s)],[i[0].concat(a[0]),i[1].concat(a[1]),[0,0,1]]),m=x(n).concat([1]),v=[M(m,p[0]),M(m,p[1])];return l.map((function(t){return[t[0]+v[0],t[1]+v[1],t[2]]}))},t.prototype.estimateHand=function(t){return g(this,void 0,void 0,(function(){var e,r,o,i,s,a,u,h,d,l,m,v,P,g,k,y,w,L,B,I;return b(this,(function(b){switch(b.label){case 0:return!0!==(e=this.shouldUpdateRegionsOfInterest())?[3,2]:[4,this.boundingBoxDetector.estimateHandBounds(t)];case 1:return null===(r=b.sent())?(t.dispose(),this.regionsOfInterest=[],[2,null]):(this.updateRegionsOfInterest(r,!0),this.runsWithoutHandDetector=0,[3,3]);case 2:this.runsWithoutHandDetector++,b.label=3;case 3:return o=this.regionsOfInterest[0],i=C(o.palmLandmarks[0],o.palmLandmarks[2]),s=x(o),a=[s[0]/t.shape[2],s[1]/t.shape[1]],u=n.rotateWithOffset(t,i,0,a),h=O(-i,s),d=!0===e?this.getBoxForPalmLandmarks(o.palmLandmarks,h):o,l=function(t,e,r){var o=e.shape[1],i=e.shape[2],s=[[t.startPoint[1]/o,t.startPoint[0]/i,t.endPoint[1]/o,t.endPoint[0]/i]];return n.cropAndResize(e,s,[0],r)}(d,u,[this.meshWidth,this.meshHeight]),m=l.div(255),l.dispose(),u.dispose(),"webgl"===c()?(P=f().get("WEBGL_PACK_DEPTHWISECONV"),f().set("WEBGL_PACK_DEPTHWISECONV",!0),v=this.meshDetector.predict(m),f().set("WEBGL_PACK_DEPTHWISECONV",P)):v=this.meshDetector.predict(m),g=v[0],k=v[1],m.dispose(),y=g.dataSync()[0],g.dispose(),y<this.detectionConfidence?(k.dispose(),this.regionsOfInterest=[],[2,null]):(w=p(k,[-1,3]),L=w.arraySync(),k.dispose(),w.dispose(),B=this.transformRawCoords(L,d,i,h),I=this.getBoxForHandLandmarks(B),this.updateRegionsOfInterest(I,!1),[2,{landmarks:B,handInViewConfidence:y,boundingBox:{topLeft:I.startPoint,bottomRight:I.endPoint}}])}}))}))},t.prototype.calculateLandmarksBoundingBox=function(t){var n=t.map((function(t){return t[0]})),e=t.map((function(t){return t[1]}));return{startPoint:[Math.min.apply(Math,n),Math.min.apply(Math,e)],endPoint:[Math.max.apply(Math,n),Math.max.apply(Math,e)]}},t.prototype.updateRegionsOfInterest=function(t,n){if(n)this.regionsOfInterest=[t];else{var e=this.regionsOfInterest[0],r=0;if(null!=e&&null!=e.startPoint){var o=t.startPoint,i=o[0],s=o[1],a=t.endPoint,u=a[0],h=a[1],d=e.startPoint,c=d[0],f=d[1],l=e.endPoint,p=l[0],m=l[1],v=Math.max(i,c),P=Math.max(s,f),g=(Math.min(u,p)-v)*(Math.min(h,m)-P);r=g/((u-i)*(h-s)+(p-c)*(m-s)-g)}this.regionsOfInterest[0]=r>.8?e:t}},t.prototype.shouldUpdateRegionsOfInterest=function(){return this.regionsOfInterest.length!==this.maxHandsNumber||this.runsWithoutHandDetector>=this.maxContinuousChecks},t}();function R(){return g(this,void 0,void 0,(function(){return b(this,(function(n){return"https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",[2,t("https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",{fromTFHub:!0})]}))}))}function j(){return g(this,void 0,void 0,(function(){return b(this,(function(n){return"https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",[2,t("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",{fromTFHub:!0})]}))}))}function V(){return g(this,void 0,void 0,(function(){return b(this,(function(t){return[2,m.fetch("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1/anchors.json?tfjs-format=file").then((function(t){return t.json()}))]}))}))}function F(t){var n=void 0===t?{}:t,e=n.maxContinuousChecks,r=void 0===e?1/0:e,o=n.detectionConfidence,i=void 0===o?.8:o,s=n.iouThreshold,a=void 0===s?.3:s,u=n.scoreThreshold,h=void 0===u?.5:u;return g(this,void 0,void 0,(function(){var t,n,e,o,s,u;return b(this,(function(d){switch(d.label){case 0:return[4,Promise.all([V(),R(),j()])];case 1:return t=d.sent(),n=t[0],e=t[1],o=t[2],s=new B(e,256,256,n,a,h),u=new _(s,o,256,256,r,i),[2,new A(u)]}}))}))}var A=function(){function t(t){this.pipeline=t}return t.getAnnotations=function(){return I},t.prototype.estimateHands=function(t,n){return void 0===n&&(n=!1),g(this,void 0,void 0,(function(){var e,r,i,s,a,u,h,d,c;return b(this,(function(f){switch(f.label){case 0:return e=function(t){return t instanceof v?[t.shape[0],t.shape[1]]:[t.height,t.width]}(t),r=e[1],i=o((function(){return t instanceof v||(t=P.fromPixels(t)),t.toFloat().expandDims(0)})),[4,this.pipeline.estimateHand(i)];case 1:if(s=f.sent(),i.dispose(),null===s)return[2,[]];for(a=s,!0===n&&(a=function(t,n){var e=t.handInViewConfidence,r=t.landmarks,o=t.boundingBox;return{handInViewConfidence:e,landmarks:r.map((function(t){return[n-1-t[0],t[1],t[2]]})),boundingBox:{topLeft:[n-1-o.topLeft[0],o.topLeft[1]],bottomRight:[n-1-o.bottomRight[0],o.bottomRight[1]]}}}(s,r)),u={},h=0,d=Object.keys(I);h<d.length;h++)c=d[h],u[c]=I[c].map((function(t){return a.landmarks[t]}));return[2,[{handInViewConfidence:a.handInViewConfidence,boundingBox:a.boundingBox,landmarks:a.landmarks,annotations:u}]]}}))}))},t}();export{A as HandPose,F as load};
